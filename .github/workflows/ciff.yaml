name: Paketo Build Reproduction

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  pack-build:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: failure-test
      BUILDER: hts2-ap-docker.jfrog.io/paketobuildpacks/builder-jammy-base
      POETRY_HTTP_BASIC_AP_ARTIFACTORY_USERNAME: "${{ secrets.JF_USER }}"
      POETRY_HTTP_BASIC_AP_ARTIFACTORY_PASSWORD: "${{ secrets.ARTIFACTORY_ACCESS_TOKEN }}"

    steps:
      - name: Log in to Artifactory Docker Registry
        uses: docker/login-action@v3
        with:
          registry: hts2-ap-docker.jfrog.io
          username: ${{ secrets.JF_USER }}
          password: ${{ secrets.ARTIFACTORY_ACCESS_TOKEN }}

      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install pack CLI
        run: |
          PACK_VERSION=$(curl -s https://api.github.com/repos/buildpacks/pack/releases/latest | grep tag_name | cut -d '"' -f4)
          echo "Installing pack version ${PACK_VERSION}"
          curl -sL "https://github.com/buildpacks/pack/releases/download/${PACK_VERSION}/pack-${PACK_VERSION}-linux.tgz" \
            | sudo tar -C /usr/local/bin/ -xz pack
          pack version

      - name: List repo files
        run: ls -R

      - name: Verify Python build files
        run: |
          if [ ! -f "pyproject.toml" ] && [ ! -f "requirements.txt" ]; then
            echo "❌ Error: pyproject.toml or requirements.txt not found!"
            exit 1
          else
            echo "✅ Python build file detected."
          fi

      - name: Build the image using Paketo buildpacks
        run: |
          pack build $IMAGE_NAME \
            --builder $BUILDER \
            --trust-builder \
            -e POETRY_HTTP_BASIC_AP_ARTIFACTORY_USERNAME="$POETRY_HTTP_BASIC_AP_ARTIFACTORY_USERNAME" \
            -e POETRY_HTTP_BASIC_AP_ARTIFACTORY_PASSWORD="$POETRY_HTTP_BASIC_AP_ARTIFACTORY_PASSWORD"

      - name: Verify built image
        run: docker images | grep $IMAGE_NAME
